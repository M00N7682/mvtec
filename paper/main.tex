\documentclass[11pt]{article}
\usepackage[margin=1in]{geometry}
\usepackage{amsmath,amssymb}
\usepackage{graphicx}
\usepackage{booktabs}
\usepackage{hyperref}
\usepackage{caption}
\usepackage{subcaption}
\usepackage{kotex}

\title{RDI-Net: 극단적 클래스 불균형 환경에서의 결함 삽입 기반 이미지 합성 및 분류기 기반 이상 탐지}
\author{문덕룡}
\date{\today}

\begin{document}
\maketitle

\begin{abstract}
산업 결함 데이터는 정상 샘플이 풍부한 반면 결함 샘플은 극히 희소하여, 데이터 불균형이 학습 성능과 일반화에 구조적 제약으로 작용한다.
이러한 환경에서 합성 데이터는 유망한 대안이지만, 단순한 복제나 나이브한 붙여넣기 방식은 경계 인공물(artifact)을 유발하거나 결함 패턴의 구조를 왜곡하여 다운스트림 탐지 효용을 떨어뜨릴 수 있다.
본 연구는 정상 이미지의 배경 문맥을 최대한 보존하면서 결함을 국소적으로 삽입하는 합성 프레임워크 \textit{RDI-Net}을 제안한다.
핵심 아이디어는 전체 이미지를 새로 생성하는 대신, 결함 마스크 영역에서만 잔차(residual)와 블렌딩 맵을 생성하여 결함을 ``삽입하고 조화(harmonize)''하는 것이다.
우리는 MVTec AD의 다섯 개 카테고리(bottle, cable, capsule, hazelnut, metal\_nut)에서 결함 K-shot 설정($K\in\{1,5,10\}$)을 구성하고, ResNet-18 기반 이진 분류기에서 image-level AUROC로 효용을 평가한다.
또한 합성 데이터가 ``너무 티가 나서'' 모델이 합성 인공물에 과적합하는 위험을 통제하기 위해, 실제 결함 패치와 합성 결함 패치의 구분 가능성(real-vs-synthetic discriminability)을 별도의 편향 점검(bias check)으로 보고한다.
\end{abstract}

\section{Introduction}
산업 현장에서의 비전 기반 검사(visual inspection)는 결함을 조기에 탐지해 품질과 안전을 보장하는 핵심 공정이다.
그러나 실제 데이터 수집 과정에서는 정상 샘플이 대량으로 축적되는 반면, 결함은 발생 빈도 자체가 낮고 다양한 유형으로 분산되기 때문에 라벨이 달린 결함 데이터를 충분히 확보하기 어렵다.
이와 같은 극단적 클래스 불균형은 지도 학습 기반 분류기에서 특히 치명적이며, 결함 클래스의 다양성을 학습하지 못해 결정경계가 불안정해지거나 특정 결함 패턴에 과적합되는 문제가 발생한다.

이러한 맥락에서 합성 데이터는 결함 샘플의 ``절대량''을 보완할 수 있는 실용적 수단이지만, 합성의 품질을 무엇으로 정의할 것인지는 단순하지 않다.
예를 들어, 정상 이미지 위에 결함 패치를 단순히 붙여넣는 방식은 구현이 쉽지만, 결함 경계 주변에 비자연스러운 블렌딩 흔적이 남기 쉽고, 모델이 결함 자체가 아니라 합성 흔적을 단서로 삼아 과적합하는 위험이 있다.
반대로 전체 이미지를 생성하는 대규모 생성 모델은 데이터와 계산 요구가 크며, 희소 모드를 안정적으로 학습시키기 어렵다.

본 연구는 ``불균형 환경에서 유용한 결함 합성''을 목표로, 결함을 전역적으로 생성하는 대신 국소 삽입 문제로 재정의한다.
구체적으로 RDI-Net은 정상 배경을 최대한 유지한 채 결함 영역에서만 잔차 및 블렌딩 맵을 예측하여 합성 결함을 생성한다.
또한 실험 프로토콜을 재현 가능하게 구성하기 위해 MVTec AD에서 K-shot 결함 설정($K\in\{1,5,10\}$)을 만들고, 분류기 기반 이상 탐지에서 image-level AUROC를 주요 지표로 사용한다.
마지막으로 합성 데이터가 만들어내는 잠재적 편향을 점검하기 위해, 실제 결함 패치와 합성 결함 패치가 얼마나 쉽게 구분되는지를 별도 지표로 보고한다.

\section{Problem Setup}
정상 이미지를 $x\in\mathbb{R}^{H\times W\times 3}$, 결함 마스크를 $m\in\{0,1\}^{H\times W}$로 두자.
훈련 시점에서 결함 샘플은 카테고리별로 $K$개만 주어진다고 가정하며($K$-shot), 이들 결함과 마스크를 이용해 추가적인 합성 결함 이미지 $\tilde{x}$를 생성한다.
다운스트림 과제는 정상/결함 이진 분류기에 기반한 이상 탐지이며, 테스트 셋에서 image-level AUROC를 최대화하는 것을 목표로 한다.

\section{Method}
\subsection{Baselines}
베이스라인으로는 (i) 결함 패치를 정상 이미지 위에 직접 삽입하는 Copy-Paste와, (ii) 마스크 경계를 완화하여 삽입 흔적을 줄이려는 간단한 블렌딩 변형(poisson-like)을 구현한다.
이때 결함 패치는 K-shot 결함 이미지와 마스크로부터 추출한 패치 뱅크에서 샘플링하며, 각 정상 이미지에 결함을 1개만 삽입하도록 고정해 합성량에 의한 효과를 최소화한다.

\subsection{RDI-Net}
RDI-Net은 ``정상 배경을 유지한 채 결함만 국소적으로 삽입''한다는 목표를 직접적으로 반영한 합성 모델이다.
전체 이미지를 새로 샘플링하는 대신, 정상 이미지 위에서 결함 마스크 영역에만 변화를 주는 잔차(residual) 기반 합성을 수행한다.
구체적으로, 정상 이미지 $x$와 결함 마스크 $m$가 주어졌을 때 RDI-Net은 잔차 $r$과 블렌딩 맵 $\alpha$를 예측하며, 합성 이미지는 다음과 같이 생성된다.
\[
\tilde{x} = x + \alpha \odot m \odot r.
\]
여기서 $\odot$는 원소별 곱이다.
설계 의도는 명확하다. 마스크 외부에서는 $x$를 거의 변경하지 않으면서, 마스크 내부에서는 결함 패턴을 생성하고 경계 부근에서는 $\alpha$를 통해 자연스럽게 조화시킨다.

\paragraph{학습 신호(자가 지도, pseudo-normal 복원).}
결함 샘플이 매우 적은 환경에서는 ``정상 이미지를 위한 GT''가 존재하지 않으므로, 우리는 결함 이미지 $x_d$로부터 마스크 영역을 간단히 메우는 방식으로 pseudo-normal $x_n$을 구성한다.
구현에서는 마스크 주변의 경계 링(ring)에서 평균 색상을 추정해 마스크 내부를 채운 뒤 가우시안 블러로 경계의 급격한 단절을 완화한다.
이후 네트워크는 $x_n$과 $m$ (그리고 다양성 확보를 위한 잡음 $z$)를 입력으로 받아 $x_d$를 복원하도록 학습된다.
손실은 (i) 마스크 내부 복원 오차($\ell_1$), (ii) 마스크 외부 동일성(Identity) 유지($\ell_1$), (iii) 블렌딩 맵 $\alpha$의 총변동(TV) 정규화로 구성한다.
요약하면, RDI-Net은 ``마스크 내부에서만 필요한 변화를 배우고, 마스크 외부에서는 바꾸지 말라''는 유도 신호를 명시적으로 받는다.

\paragraph{합성(정상 이미지 위 결함 삽입).}
학습된 모델은 정상 이미지에 결함 마스크를 얹고 잡음 $z$를 샘플링하여 다양한 결함 잔차를 생성한다.
본 연구에서는 결함 마스크를 단순 평행이동(translation)하여 정상 이미지 내 위치를 변화시키는 방식으로 다양성을 확보한다.
이 구성은 계산 자원이 제한된 환경에서 간단히 구현되며, ``배경 문맥은 유지하면서 결함 영역만 다양화''하는 문제 정의에 부합한다.

\section{Experiments}
\subsection{Dataset and Protocol}
우리는 MVTec AD의 다섯 개 카테고리(bottle, cable, capsule, hazelnut, metal\_nut)를 사용한다.
해상도는 256으로 고정한다.
K-shot 결함 프로토콜은 재현성을 위해 고정 시드로 구성하며, 테스트 셋은 각 카테고리의 표준 테스트 구조를 유지한다.

\subsection{Metrics}
주요 지표는 테스트 셋에서의 image-level AUROC이다.
또한 합성 편향을 점검하기 위해, 실제 결함 패치와 합성 결함 패치를 구분하는 이진 분류기의 AUROC를 함께 보고한다.
이 값이 지나치게 높다면(=매우 쉽게 구분된다면) 합성 인공물이 강하다는 신호로 해석할 수 있다.

\subsection{Results}
표~\ref{tab:main}은 파이프라인 출력(\texttt{outputs/baselines/summary.csv})으로부터 채워진다.
본 절의 수치는 단일 시드(42)에서의 결과이며, 분류기는 256 해상도에서 3 epoch로 학습하였다(정상 200장 + 합성 결함 200장, $K\in\{1,5,10\}$).
합성은 $K$-shot 결함 패치 뱅크에서 샘플링하여 정상 이미지에 결함을 1개 삽입하는 방식으로 구성하였다.

\begin{table}[t]
\centering
\caption{Image-level AUROC (5개 카테고리 평균). 파이프라인 결과로 채움.}
\label{tab:main}
\begin{tabular}{lccc}
\toprule
Method & $K=1$ & $K=5$ & $K=10$ \\
\midrule
\input{tables/baseline_mean_rows}
\bottomrule
\end{tabular}
\end{table}

표~\ref{tab:main}에서 베이스라인 합성은 $K=1$에서 No synth 대비 평균 AUROC를 크게 개선한다(0.7473 $\rightarrow$ 0.8851/0.8739).
이는 극단적 희소 결함 환경에서는 합성 데이터가 결정경계를 안정화시키는 데 유의미하게 기여할 수 있음을 보여준다.
반면 $K=10$에서는 No synth 자체가 이미 높은 성능(0.9532)을 보이며, 추가 합성의 평균 이득은 제한적이다.
정상-only 계열인 PaDiM-lite는 $K$ 변화에 크게 민감하지 않으며 전반적으로 높은 AUROC(약 0.96 내외)를 유지한다.

제안 방법 RDI-Net은 $K=1$에서 No synth 대비 평균 AUROC를 소폭 개선(0.7473 $\rightarrow$ 0.7566)하지만,
단순한 Copy-Paste/Poisson-like 대비로는 평균 성능이 낮게 관측되었다.
이는 본 연구의 RDI-Net 구현이 ``국소 삽입'' 문제를 직접 다루는 최소 구성(v0)임을 반영하며,
향후 문맥 조건화와 결함 구조 보존 손실을 포함한 강화된 변형이 필요함을 시사한다.
또한 카테고리별 편차가 크게 나타나는데, 예컨대 hazelnut의 $K=5$에서는 매우 높은 성능(0.9996)을 보인 반면,
hazelnut의 $K=10$에서는 성능이 급락(0.5)하는 등 불안정성이 관찰되었다.
이러한 현상은 마스크 이동 기반 다양화가 도메인 제약(결함 위치/형태의 유효 범위)을 위반했을 가능성,
또는 pseudo-normal 구성 과정에서 특정 카테고리에서 부정확한 복원 신호가 생성되었을 가능성과 관련될 수 있다.
따라서 본 논문은 평균 성능뿐 아니라 카테고리별 결과와 실패 사례를 함께 해석하는 것을 강조한다.

합성의 편향은 표~\ref{tab:bias}의 real-vs-synthetic 구분 가능성으로 추가 분석한다.

\input{tables/bias_mean_table}

그림~\ref{fig:auroc_k}는 \texttt{scripts/make\_figures.py}가 생성한 K에 따른 평균 AUROC 변화를 시각화한다.

\begin{figure}[t]
\centering
\includegraphics[width=0.7\linewidth]{../outputs/figures/auroc_vs_k_mean.png}
\caption{K-shot에 따른 평균 AUROC 변화(베이스라인).}
\label{fig:auroc_k}
\end{figure}

\section{Discussion}
표~\ref{tab:main}과 표~\ref{tab:bias}를 함께 보면, 극단적 불균형에서는 ``합성이 있다''는 사실 자체가 성능에 큰 영향을 주지만,
어떤 합성이 ``유용한 다양성''을 제공하는지는 별개의 문제임을 알 수 있다.
Copy-Paste/Poisson-like는 $K=1$에서 큰 성능 향상을 보였으나, 동시에 real-vs-synthetic 구분 AUROC가 매우 높아(거의 1에 근접) 합성 인공물이 강하게 드러났음을 시사한다.
이는 모델이 합성 흔적을 단서로 삼을 위험이 있음을 의미하며, 합성의 효용이 데이터/카테고리에 따라 달라질 수 있다는 경고로 해석할 수 있다.

RDI-Net은 이러한 긴장을 ``국소 삽입'' 문제의 형태로 정식화하고, 마스크 외부 동일성을 강제함으로써 배경 문맥 보존을 직접 유도한다.
그러나 본 연구에서 구현한 최소 구성(v0)은 pseudo-normal 복원 신호에 크게 의존하며, 결함의 구조적 통계(예: 임베딩 공간의 분산/공분산) 보존이나 문맥 조건화가 충분히 반영되지 않았다.
그 결과 일부 카테고리에서 불안정한 학습과 급격한 성능 저하가 관찰되었다.
이러한 한계는 ``생성 품질''과 ``다운스트림 효용''의 불일치 가능성을 다시 한 번 강조하며,
향후에는 (i) 결함 위치/형태에 대한 도메인 제약을 반영한 마스크 샘플링,
(ii) 사전학습 인코더 임베딩에서 결함 패치 분포를 보존하는 패턴 보존 손실,
(iii) 경계 조화를 위한 보다 강한 조화 모듈(예: 멀티스케일 문맥 조건화)
등을 통해 안정성과 일반화를 개선할 필요가 있다.

\paragraph{한계 및 재현성.}
본 논문의 수치는 단일 시드에서의 결과이며, few-shot 설정에서의 분산을 정량화하기 위해 다중 시드 평균/표준편차 보고가 필요하다.
또한 RDI-Net은 단일 GPU/MPS 환경을 고려해 설계되었으나, 하드웨어/드라이버에 따른 실행 시간 및 안정성 편차가 발생할 수 있다.

\section{Conclusion}
본 연구는 K-shot 결함 환경에서 결함 삽입 기반 합성 데이터를 활용해 분류기 기반 이상 탐지 성능을 개선하는 문제를 다루었다.
우리는 재현 가능한 데이터 분할과 베이스라인을 포함한 end-to-end 파이프라인을 제공하고, RDI-Net을 통해 국소 결함 삽입 및 조화에 기반한 합성 전략을 제안한다.

\bibliographystyle{plain}
\bibliography{refs}

\end{document}


